{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
    /* Z√°kladn√≠ rozvr≈æen√≠ ar√©ny */
    .arena-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: url('{% static "game/img/dungeon_bg.jpg" %}') no-repeat center center; /* Pokud m√°≈° pozad√≠ */
        background-size: cover;
        background-color: #2c3e50;
        min-height: 500px;
        border-radius: 15px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        color: white;
        font-family: 'Verdana', sans-serif;
        box-shadow: inset 0 0 50px #000;
    }

    /* Karty bojovn√≠k≈Ø */
    .fighter-card {
        width: 300px;
        text-align: center;
        position: relative;
        transition: transform 0.2s;
        z-index: 10;
    }

    .fighter-image-wrapper {
        width: 200px;
        height: 200px;
        margin: 0 auto;
        position: relative;
    }

    .fighter-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 0 10px rgba(0,0,0,0.8));
    }

    /* Health Bar */
    .health-bar-container {
        width: 100%;
        height: 25px;
        background-color: #444;
        border: 2px solid #222;
        border-radius: 10px;
        margin-top: 10px;
        position: relative;
        overflow: hidden;
    }

    .health-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        width: 100%; /* JS bude mƒõnit */
        transition: width 0.5s ease-out;
    }

    .health-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        line-height: 22px;
        font-weight: bold;
        font-size: 14px;
        text-shadow: 1px 1px 2px black;
    }

    /* VS text uprost≈ôed */
    .vs-text {
        font-size: 3rem;
        font-weight: 900;
        color: #f1c40f;
        text-shadow: 2px 2px 10px #000;
        z-index: 5;
    }

    /* Plovouc√≠ text po≈°kozen√≠ (Floating Combat Text) */
    .damage-number {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        font-weight: bold;
        color: #ff0000;
        text-shadow: 2px 2px 0 #fff;
        opacity: 0;
        pointer-events: none;
        z-index: 20;
    }

    /* Tlaƒç√≠tka ovl√°d√°n√≠ */
    .controls {
        text-align: center;
        margin-top: 20px;
    }

    .btn-fight {
        font-size: 1.2rem;
        padding: 10px 30px;
    }

    /* LOG TEXT */
    #battle-log-text {
        text-align: center;
        margin-top: 15px;
        font-size: 1.2rem;
        font-style: italic;
        color: #bdc3c7;
        min-height: 30px;
    }

    /* ANIMACE */
    
    /* √ötok hr√°ƒçe (zleva doprava) */
    @keyframes attack-right {
        0% { transform: translateX(0); }
        40% { transform: translateX(50px) rotate(10deg); }
        50% { transform: translateX(150px) scale(1.1); }
        100% { transform: translateX(0); }
    }

    /* √ötok bosse (zprava doleva) */
    @keyframes attack-left {
        0% { transform: translateX(0); }
        40% { transform: translateX(-50px) rotate(-10deg); }
        50% { transform: translateX(-150px) scale(1.1); }
        100% { transform: translateX(0); }
    }

    /* Z√°sah (ot≈ôes) */
    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); filter: brightness(1); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } /* Zƒçerven√°n√≠ */
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        100% { transform: translate(0, 0) rotate(0deg); filter: brightness(1); }
    }

    /* Zobrazen√≠ ƒç√≠sla */
    @keyframes float-up {
        0% { opacity: 1; transform: translate(-50%, 0) scale(0.5); }
        20% { transform: translate(-50%, -20px) scale(1.5); }
        80% { opacity: 1; transform: translate(-50%, -50px) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -80px); }
    }

    .anim-attack-player { animation: attack-right 0.4s ease-in-out; }
    .anim-attack-boss { animation: attack-left 0.4s ease-in-out; }
    .anim-hit { animation: shake 0.5s; }
    .anim-damage { animation: float-up 1s ease-out forwards; }
    .dead { filter: grayscale(100%) blur(2px); opacity: 0.6; }

</style>

<div class="container my-4">
    <h1 class="text-center mb-4">‚öîÔ∏è Ar√©na ‚öîÔ∏è</h1>

    <div class="arena-container">
        
        <div class="fighter-card" id="player-card">
            <h3 id="player-name">Hr√°ƒç</h3>
            <div class="fighter-image-wrapper">
                <img src="" id="player-img" class="fighter-image" alt="Player">
                <div class="damage-number" id="player-dmg-text"></div>
            </div>
            <div class="health-bar-container">
                <div class="health-bar-fill" id="player-hp-bar"></div>
                <div class="health-text" id="player-hp-text">? / ?</div>
            </div>
        </div>

        <div class="vs-text">VS</div>

        <div class="fighter-card" id="boss-card">
            <h3>{{ fight_log.boss.name }}</h3>
            <div class="fighter-image-wrapper">
                {% if fight_log.boss.boss_img %}
                    <img src="{{ fight_log.boss.boss_img.url }}" class="fighter-image" alt="Boss">
                {% else %}
                    <img src="{% static 'game/img/default_boss.png' %}" class="fighter-image" alt="Boss">
                {% endif %}
                <div class="damage-number" id="boss-dmg-text"></div>
            </div>
            <div class="health-bar-container">
                <div class="health-bar-fill" id="boss-hp-bar"></div>
                <div class="health-text" id="boss-hp-text">?</div>
            </div>
        </div>

    </div>

    <div id="battle-log-text">Klikni na Start pro zah√°jen√≠ replaye...</div>

    <div class="controls">
        <button class="btn btn-success btn-fight" onclick="startBattle()">‚ñ∂ P≈ôehr√°t Souboj</button>
        <button class="btn btn-secondary btn-fight" onclick="togglePause()">‚è∏ Pauza</button>
        <a href="{% url 'dungeon' %}" class="btn btn-primary btn-fight" id="btn-back" style="display:none;">Zpƒõt do Dungeonu</a>
    </div>

    <div id="battle-result" class="alert mt-4 text-center" style="display:none;">
        <h2 id="result-title"></h2>
        <p>Celkov√© po≈°kozen√≠ udƒõlen√© hr√°ƒçi: <strong>{{ fight_log.total_damage_dealt_by_players }}</strong></p>
    </div>

</div>

<script>
    // P≈ôed√°n√≠ dat z Django do JS promƒõnn√©
    const battleData = [
        {% for turn in turn_logs %}
        {
            turn: {{ turn.turn_number }},
            is_boss_attack: {% if turn.attacker_is_boss %}true{% else %}false{% endif %},
            
            // Info o √∫toƒçn√≠kovi a c√≠li
            attacker_name: "{% if turn.attacker_is_boss %}{{ fight_log.boss.name }}{% else %}{{ turn.attacker_player.name }}{% endif %}",
            target_name: "{% if turn.attacker_is_boss %}{{ turn.target_player.name }}{% else %}{{ fight_log.boss.name }}{% endif %}",
            
            // URL Obr√°zk≈Ø (zajist√≠me fallback, pokud obr√°zek nen√≠)
            player_img: "{% if turn.attacker_is_boss %}{% if turn.target_player.profile_img %}{{ turn.target_player.profile_img.url }}{% endif %}{% else %}{% if turn.attacker_player.profile_img %}{{ turn.attacker_player.profile_img.url }}{% endif %}{% endif %}",

            // ƒå√≠sla
            dmg: {{ turn.damage_dealt }},
            boss_hp: {{ turn.boss_hp_after }},
            // Pokud je c√≠l boss, target_player_hp_after je null, mus√≠me to o≈°et≈ôit
            player_hp: {% if turn.target_player_hp_after is not None %}{{ turn.target_player_hp_after }}{% else %}null{% endif %}
        },
        {% endfor %}
    ];

    // V√Ωsledek boje
    const finalOutcome = "{{ fight_log.outcome }}";
    const finalBossHp = {{ fight_log.final_boss_hp }};
    
    // Zkus√≠me odhadnout MAX HP pro vykreslen√≠ baru (vezmeme nejvy≈°≈°√≠ HP z log≈Ø nebo aktu√°ln√≠ + dmg)
    // Toto je jednoduch√° heuristika, ide√°lnƒõ bys mƒõl pos√≠lat max_hp z backendu
    let maxBossHp = battleData.length > 0 ? (battleData[0].boss_hp + battleData[0].dmg) : 100;
    // Pokud je prvn√≠ tah √∫tok bosse, HP bosse se nemƒõn√≠, tak vezmeme rovnou
    if(battleData.length > 0 && battleData[0].is_boss_attack) maxBossHp = battleData[0].boss_hp;

    // Pro hr√°ƒçe je to slo≈æitƒõj≈°√≠, proto≈æe se st≈ô√≠daj√≠. Budeme prostƒõ zobrazovat HP.
</script>

<script>
    let currentTurnIndex = 0;
    let isPaused = false;
    let battleInterval;
    const turnDelay = 1500; // Rychlost tah≈Ø v ms

    // Elementy
    const playerCard = document.getElementById('player-card');
    const playerImg = document.getElementById('player-img');
    const playerName = document.getElementById('player-name');
    const playerHpText = document.getElementById('player-hp-text');
    const playerHpBar = document.getElementById('player-hp-bar');
    const playerDmgText = document.getElementById('player-dmg-text');

    const bossCard = document.getElementById('boss-card');
    const bossHpText = document.getElementById('boss-hp-text');
    const bossHpBar = document.getElementById('boss-hp-bar');
    const bossDmgText = document.getElementById('boss-dmg-text');

    const logText = document.getElementById('battle-log-text');
    const resultDiv = document.getElementById('battle-result');
    const btnBack = document.getElementById('btn-back');

    // Inicializace prvn√≠ho stavu
    function initBattle() {
        if(battleData.length > 0) {
            updateStats(battleData[0], true); // true = reset only
        }
    }

    // Pomocn√° funkce pro ƒçek√°n√≠
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function startBattle() {
        // Reset
        currentTurnIndex = 0;
        resultDiv.style.display = 'none';
        btnBack.style.display = 'none';
        
        // Loop p≈ôes v≈°echny tahy
        while (currentTurnIndex < battleData.length) {
            if (isPaused) {
                await sleep(100);
                continue;
            }

            const turn = battleData[currentTurnIndex];
            await playTurn(turn);
            currentTurnIndex++;
        }

        // Konec boje
        endBattle();
    }

    function togglePause() {
        isPaused = !isPaused;
    }

    async function playTurn(turn) {
        // 1. Nastav√≠me spr√°vn√©ho hr√°ƒçe (obr√°zek a jm√©no)
        // Pokud √∫toƒç√≠ boss, c√≠lem je hr√°ƒç. Pokud √∫toƒç√≠ hr√°ƒç, je to on.
        // Data player_img jsme p≈ôipravili v JSONu tak, ≈æe v≈ædy obsahuj√≠ URL hr√°ƒçe v dan√©m kole.
        if (turn.player_img) {
            playerImg.src = turn.player_img;
        } else {
            // Fallback ikona
            playerImg.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png"; 
        }
        
        // Jm√©no hr√°ƒçe
        playerName.innerText = turn.is_boss_attack ? turn.target_name : turn.attacker_name;


        // 2. Text logu
        logText.innerText = `Tah ${turn.turn}: ${turn.attacker_name} √∫toƒç√≠ na ${turn.target_name} za ${turn.dmg} po≈°kozen√≠!`;

        // 3. Animace √öTOKU
        if (turn.is_boss_attack) {
            // Boss √∫toƒç√≠ na Hr√°ƒçe
            bossCard.classList.add('anim-attack-boss');
            await sleep(200); // ƒåas na "n√°p≈ôah"
            
            // Z√°sah!
            playerCard.classList.add('anim-hit');
            showDamage(playerDmgText, turn.dmg);
            
        } else {
            // Hr√°ƒç √∫toƒç√≠ na Bosse
            playerCard.classList.add('anim-attack-player');
            await sleep(200);
            
            // Z√°sah!
            bossCard.classList.add('anim-hit');
            showDamage(bossDmgText, turn.dmg);
        }

        // 4. Aktualizace HP (s mal√Ωm zpo≈ædƒõn√≠m po z√°sahu)
        await sleep(100);
        updateHealthUI(turn);

        // 5. √öklid t≈ô√≠d (reset animac√≠)
        await sleep(600); // Poƒçk√°me na dokonƒçen√≠ animac√≠
        bossCard.classList.remove('anim-attack-boss', 'anim-hit');
        playerCard.classList.remove('anim-attack-player', 'anim-hit');
        
        // ƒåek√°n√≠ p≈ôed dal≈°√≠m tahem
        await sleep(turnDelay - 900);
    }

    function showDamage(element, amount) {
        element.innerText = "-" + amount;
        // Reset animace - trik s reflow
        element.classList.remove('anim-damage');
        void element.offsetWidth; 
        element.classList.add('anim-damage');
    }

    function updateHealthUI(turn) {
        // Boss HP
        bossHpText.innerText = turn.boss_hp;
        let bossPct = (turn.boss_hp / maxBossHp) * 100;
        if (bossPct < 0) bossPct = 0;
        bossHpBar.style.width = bossPct + "%";

        // Player HP (jen pokud bylo zasa≈æeno)
        if (turn.player_hp !== null) {
            playerHpText.innerText = turn.player_hp;
            // Nem√°me max HP hr√°ƒçe v logu, tak≈æe jen barva, nebo pln√Ω bar
            // P≈ô√≠padnƒõ m≈Ø≈æe≈° udƒõlat odhad jako u bosse
            playerHpBar.style.width = "100%"; 
            if (turn.player_hp <= 0) {
                playerHpBar.style.width = "0%";
                playerImg.classList.add('dead');
            } else {
                playerImg.classList.remove('dead');
            }
        }
    }

    // Funkce pro nastaven√≠ stat≈Ø bez animace (init)
    function updateStats(turn, init) {
        // ... (z√°kladn√≠ nastaven√≠ text≈Ø)
    }

    function endBattle() {
        logText.innerText = "Souboj skonƒçil!";
        resultDiv.style.display = 'block';
        btnBack.style.display = 'inline-block';

        const title = document.getElementById('result-title');
        if (finalOutcome === 'players') {
            title.innerHTML = "<span class='text-success'>üéâ V√çTƒöZSTV√ç HR√Åƒå≈Æ! üéâ</span>";
            bossImg = document.querySelector('#boss-card img');
            bossImg.classList.add('dead');
            bossHpBar.style.width = "0%";
            bossHpText.innerText = "0";
        } else {
            title.innerHTML = "<span class='text-danger'>üíÄ BOSS ZV√çTƒöZIL! üíÄ</span>";
            playerImg.classList.add('dead');
        }
    }

    // Spustit fallback obr√°zek p≈ôi chybƒõ
    document.querySelectorAll('img').forEach(img => {
        img.onerror = function() {
            this.src = '{% static "game/img/default_avatar.png" %}'; // Uprav si cestu k defaultn√≠mu avataru
        };
    });

</script>

{% endblock content %}