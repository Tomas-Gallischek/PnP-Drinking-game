{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
    :root {
        --arena-bg: #2c3e50;
        --hp-green: #2ecc71;
        --hp-red: #e74c3c;
        --text-gold: #f1c40f;
    }

    .arena-wrapper {
        position: relative;
        width: 100%;
        max-width: 900px;
        height: 500px;
        margin: 2rem auto;
        background: url('{% static "game/img/dungeon_bg.jpg" %}') no-repeat center bottom;
        background-size: cover;
        background-color: var(--arena-bg);
        background-opacity: 0.5;
        border: 4px solid #4a3b2a;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.8) inset;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: flex-end; /* Postavy stoj√≠ na zemi */
        padding: 0 50px 80px 50px; /* Odsazen√≠ od kraj≈Ø a zespodu */
    }

    /* Karta bojovn√≠ka */
    .fighter {
        position: relative;
        width: 200px;
        height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.2s;
        z-index: 10;
    }

    /* Obr√°zek postavy */
    .fighter-img {
        width: 200px;
        height: 200px;
        object-fit: contain;
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        transition: filter 0.3s;
    }

    .fighter-img.dead {
        filter: grayscale(100%) blur(2px);
        opacity: 0.6;
    }

    /* Health Bar Container */
    .hp-box {
        width: 100%;
        background: #333;
        border: 2px solid #000;
        border-radius: 5px;
        height: 25px;
        margin-top: 10px;
        position: relative;
    }

    .hp-bar {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        width: 100%;
        transition: width 0.5s ease-out;
    }

    .hp-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        text-align: center;
        color: white;
        font-weight: bold;
        line-height: 22px;
        font-size: 14px;
        text-shadow: 1px 1px 2px black;
    }

    .name-tag {
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 2px 10px;
        border-radius: 4px;
        margin-bottom: 5px;
        font-weight: bold;
        text-align: center;
    }

    /* --- ANIMACE --- */
    
    /* √ötok hr√°ƒçe (zleva doprava) */
    @keyframes lunge-right {
        0% { transform: translateX(0); }
        30% { transform: translateX(-20px) rotate(-5deg); } /* N√°p≈ôah */
        50% { transform: translateX(150px) rotate(5deg); } /* √öder */
        100% { transform: translateX(0); }
    }

    /* √ötok bosse (zprava doleva) */
    @keyframes lunge-left {
        0% { transform: translateX(0); }
        30% { transform: translateX(20px) rotate(5deg); } /* N√°p≈ôah */
        50% { transform: translateX(-150px) rotate(-5deg); } /* √öder */
        100% { transform: translateX(0); }
    }

    /* Ot≈ôes p≈ôi z√°sahu */
    @keyframes shake-hit {
        0% { transform: translate(0, 0); filter: brightness(1); }
        10% { transform: translate(-5px, 0); filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); } /* Zƒçerven√°n√≠ */
        30% { transform: translate(5px, 0); }
        50% { transform: translate(-5px, 0); }
        70% { transform: translate(5px, 0); }
        100% { transform: translate(0, 0); filter: brightness(1); }
    }

    /* Plovouc√≠ damage text */
    .dmg-floater {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ff0000;
        font-size: 3rem;
        font-weight: 900;
        text-shadow: 0 0 5px #fff, 2px 2px 0 #000;
        opacity: 0;
        pointer-events: none;
        z-index: 20;
    }

    @keyframes float-up-fade {
        0% { opacity: 1; transform: translate(-50%, 0) scale(0.5); }
        20% { transform: translate(-50%, -30px) scale(1.5); }
        100% { opacity: 0; transform: translate(-50%, -80px) scale(1); }
    }

    /* Aplikace animac√≠ t≈ô√≠dami */
    .anim-attack-right { animation: lunge-right 0.6s ease-in-out; }
    .anim-attack-left { animation: lunge-left 0.6s ease-in-out; }
    .anim-shake { animation: shake-hit 0.4s ease-in-out; }
    .anim-float { animation: float-up-fade 1.5s forwards; }

    /* UI Prvky */
    .battle-ui {
        text-align: center;
        margin-top: 20px;
    }

    #log-display {
        min-height: 40px;
        font-size: 1.2rem;
        color: #333;
        font-style: italic;
        margin-bottom: 20px;
    }

    .btn-start {
        font-size: 1.5rem;
        padding: 10px 40px;
        box-shadow: 0 4px 0 #2c3e50;
        transition: all 0.1s;
    }
    .btn-start:active {
        transform: translateY(4px);
        box-shadow: none;
    }

</style>

<div class="container">
    <div class="arena-wrapper">
        
        <div class="fighter" id="hero-slot">
            <div class="name-tag" id="hero-name">Hr√°ƒç</div>
            
            <div style="position: relative;">
                <img src="{% static 'game/img/default_avatar.png' %}" id="hero-img" class="fighter-img" alt="Hrdina">
                <div class="dmg-floater" id="hero-dmg-float"></div>
            </div>

            <div class="hp-box">
                <div class="hp-bar" id="hero-hp-bar" style="width: 100%;"></div>
                <div class="hp-text" id="hero-hp-text">p≈ôipraven</div>
            </div>
        </div>

        <div class="fighter" id="boss-slot">
            <div class="name-tag">{{ fight_log.boss.name }} (Lvl {{ fight_log.boss.lvl }})</div>
            
            <div style="position: relative;">
                {% if fight_log.boss.boss_img %}
                    <img src="{{ fight_log.boss.boss_img.url }}" id="boss-img" class="fighter-img" alt="Boss">
                {% else %}
                    <img src="{% static 'game/img/default_boss.png' %}" id="boss-img" class="fighter-img" alt="Boss">
                {% endif %}
                <div class="dmg-floater" id="boss-dmg-float"></div>
            </div>

            <div class="hp-box">
                <div class="hp-bar" id="boss-hp-bar" style="width: 100%;"></div>
                <div class="hp-text" id="boss-hp-text">100%</div>
            </div>
        </div>
    </div>

    <div class="battle-ui">
        <div id="log-display">P≈ôipraven k boji...</div>
        
        <button class="btn btn-warning btn-start" id="btn-start-battle" onclick="runBattle()">‚ñ∂ P≈ôehr√°t Souboj</button>
        
        <div id="end-screen" style="display:none; margin-top: 20px;">
            <h2 id="end-title"></h2>
            <a href="{% url 'dungeon' %}" class="btn btn-primary btn-lg">Zpƒõt do Dungeonu</a>
        </div>
    </div>
</div>

<script>
    // 1. P≈ò√çPRAVA DAT Z DJANGO DO JS
    // Tady si vyt√°hneme ƒçist√° data z log≈Ø. 
    // D≈Øle≈æit√©: Pokud √∫toƒç√≠ boss, pot≈ôebujeme vƒõdƒõt, na koho √∫toƒç√≠, abychom zmƒõnili obr√°zek vlevo.
    const fightData = [
        {% for turn in turn_logs %}
        {
            turn: {{ turn.turn_number }},
            is_boss_attacker: {% if turn.attacker_is_boss %}true{% else %}false{% endif %},
            dmg: {{ turn.damage_dealt }},
            
            // Jm√©no a Avatar aktivn√≠ho hr√°ƒçe (buƒè √∫toƒçn√≠k, nebo obƒõ≈•)
            player_name: "{% if turn.attacker_is_boss %}{{ turn.target_player.name }}{% else %}{{ turn.attacker_player.name }}{% endif %}",
            player_img_url: "{% if turn.attacker_is_boss %}{% if turn.target_player.profile_img %}{{ turn.target_player.profile_img.url }}{% endif %}{% else %}{% if turn.attacker_player.profile_img %}{{ turn.attacker_player.profile_img.url }}{% endif %}{% endif %}",
            
            // Stav HP po tahu
            boss_hp_after: {{ turn.boss_hp_after }},
            boss_max_hp: {{ turn.boss_max_hp|default:100 }}, // Fallback kdyby nebylo
            
            // HP Hr√°ƒçe (pozor, m≈Ø≈æe b√Ωt None v DB, pokud boss ne√∫toƒçil)
            player_hp_after: {% if turn.target_player_hp_after is not None %}{{ turn.target_player_hp_after }}{% else %}null{% endif %},
            player_max_hp: {% if turn.target_player_max_hp is not None %}{{ turn.target_player_max_hp }}{% else %}100{% endif %}
        },
        {% endfor %}
    ];

    const finalOutcome = "{{ fight_log.outcome }}";

    // 2. ELEMENTY
    const els = {
        heroSlot: document.getElementById('hero-slot'),
        bossSlot: document.getElementById('boss-slot'),
        heroImg: document.getElementById('hero-img'),
        bossImg: document.getElementById('boss-img'),
        heroName: document.getElementById('hero-name'),
        heroHpBar: document.getElementById('hero-hp-bar'),
        heroHpText: document.getElementById('hero-hp-text'),
        bossHpBar: document.getElementById('boss-hp-bar'),
        bossHpText: document.getElementById('boss-hp-text'),
        logText: document.getElementById('log-display'),
        heroDmgFloat: document.getElementById('hero-dmg-float'),
        bossDmgFloat: document.getElementById('boss-dmg-float'),
        btnStart: document.getElementById('btn-start-battle'),
        endScreen: document.getElementById('end-screen'),
        endTitle: document.getElementById('end-title')
    };

    // Pomocn√° funkce pro ƒçek√°n√≠ (Sleep)
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // 3. HLAVN√ç FUNKCE SOUBOJE
    async function runBattle() {
        // Skryjeme tlaƒç√≠tko start
        els.btnStart.style.display = 'none';
        els.logText.innerText = "Souboj zaƒç√≠n√°!";
        await wait(1000);

        // Projdeme v≈°echny tahy jeden po druh√©m
        for (let i = 0; i < fightData.length; i++) {
            await playTurn(fightData[i]);
        }

        // Konec
        showResult();
    }

    // 4. ANIMACE JEDNOHO TAHU
    async function playTurn(turn) {
        // A) P≈ò√çPRAVA SC√âNY (Nastaven√≠ obr√°zku hr√°ƒçe vlevo)
        // V≈ædy aktualizujeme lev√Ω slot na toho hr√°ƒçe, kter√©ho se tah t√Ωk√°
        if (turn.player_img_url) {
            els.heroImg.src = turn.player_img_url;
        } else {
            // Fallback ikona
            els.heroImg.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png"; 
        }
        els.heroName.innerText = turn.player_name;
        
        // Resetujeme HP bar hr√°ƒçe na "full" vizu√°lnƒõ, pokud se zmƒõn√≠ postava, 
        // nebo ho nastav√≠me na procenta, pokud zn√°me p≈ôedchoz√≠ stav (zjednodu≈°en√≠: d√°me full, pokud nev√≠me)
        // Pro efekt S&F je lep≈°√≠ nechat hr√°ƒçe, aby vidƒõl, jak mu ub√Ωv√° HP v r√°mci tahu.

        await wait(200); // Kr√°tk√° pauza na "v√Ωmƒõnu" postavy

        if (turn.is_boss_attacker) {
            // --- SC√âN√Å≈ò: BOSS √öTOƒå√ç NA HR√ÅƒåE ---
            els.logText.innerText = `üê∫ Boss √∫toƒç√≠ na ${turn.player_name}!`;
            
            // 1. Boss se nap≈ô√°hne a sekne (animace CSS t≈ô√≠dou)
            els.bossSlot.classList.add('anim-attack-left');
            await wait(300); // Poƒçk√°me na moment √∫deru (polovina animace)

            // 2. Hr√°ƒç dostane z√°sah (shake + ƒç√≠slo)
            els.heroSlot.classList.add('anim-shake');
            showFloatingDamage(els.heroDmgFloat, turn.dmg);

            // 3. Aktualizace HP Hr√°ƒçe
            updateHpBar(els.heroHpBar, els.heroHpText, turn.player_hp_after, turn.player_max_hp);

            // 4. √öklid t≈ô√≠d po animaci
            await wait(300); 
            els.bossSlot.classList.remove('anim-attack-left');
            await wait(200);
            els.heroSlot.classList.remove('anim-shake');

        } else {
            // --- SC√âN√Å≈ò: HR√Åƒå √öTOƒå√ç NA BOSSE ---
            els.logText.innerText = `‚öîÔ∏è ${turn.player_name} √∫toƒç√≠ na Bosse!`;

            // 1. Hr√°ƒç se nap≈ô√°hne a sekne
            els.heroSlot.classList.add('anim-attack-right');
            await wait(300);

            // 2. Boss dostane z√°sah
            els.bossSlot.classList.add('anim-shake');
            showFloatingDamage(els.bossDmgFloat, turn.dmg);

            // 3. Aktualizace HP Bosse
            updateHpBar(els.bossHpBar, els.bossHpText, turn.boss_hp_after, turn.boss_max_hp);

            // 4. √öklid
            await wait(300);
            els.heroSlot.classList.remove('anim-attack-right');
            await wait(200);
            els.bossSlot.classList.remove('anim-shake');
        }

        // Pauza mezi tahy
        await wait(500);
    }

    // Funkce pro zobrazen√≠ plovouc√≠ho ƒç√≠sla
    function showFloatingDamage(element, dmg) {
        if (dmg <= 0) {
            element.innerText = "MISS";
            element.style.color = "#bdc3c7";
        } else {
            element.innerText = "-" + dmg;
            element.style.color = "#ff0000";
        }
        
        // Restart animace (trik s reflow)
        element.classList.remove('anim-float');
        void element.offsetWidth; 
        element.classList.add('anim-float');
    }

    // Funkce pro update HP baru
    function updateHpBar(barEl, textEl, current, max) {
        if (current === null) return; // O≈°et≈ôen√≠ null
        
        // O≈°et≈ôen√≠ z√°porn√Ωch ƒç√≠sel
        if (current < 0) current = 0;

        const percent = (current / max) * 100;
        barEl.style.width = percent + "%";
        textEl.innerText = `${current} / ${max}`;
    }

    // Z√°vƒõreƒçn√° obrazovka
    function showResult() {
        els.endScreen.style.display = 'block';
        if (finalOutcome === 'players') {
            els.endTitle.innerHTML = "<span style='color:#2ecc71'>üéâ V√çTƒöZSTV√ç! Boss byl pora≈æen. üéâ</span>";
            els.bossImg.classList.add('dead');
            els.logText.innerText = "Sl√°va v√≠tƒõz≈Øm!";
        } else {
            els.endTitle.innerHTML = "<span style='color:#e74c3c'>üíÄ PROHRA! T√Ωm byl zmasakrov√°n. üíÄ</span>";
            els.heroImg.classList.add('dead'); // Posledn√≠ aktivn√≠ hr√°ƒç
            els.logText.innerText = "ƒåest pora≈æen√Ωm...";
        }
    }
    
    // Fallback pro chybƒõj√≠c√≠ obr√°zky
    document.querySelectorAll('img').forEach(img => {
        img.onerror = function() {
            this.src = '{% static "game/img/default_avatar.png" %}'; 
        };
    });

</script>

{% endblock content %}