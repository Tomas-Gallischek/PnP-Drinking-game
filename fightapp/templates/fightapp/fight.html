{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
    :root {
        --arena-bg: #2c3e50;
        --hp-green: #2ecc71;
        --hp-red: #e74c3c;
        --text-gold: #f1c40f;
    }

    /* --- HLAVN칈 AR칄NA --- */
    .arena-wrapper {
        position: relative;
        width: 100%;
        max-width: 900px;
        height: 500px;
        margin: 2rem auto;
        background: url('{% static "game/img/dungeon_bg.jpg" %}') no-repeat center bottom;
        background-size: cover;
        background-color: var(--arena-bg);
        border: 4px solid #4a3b2a;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.8) inset;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        padding: 0 50px 80px 50px;
    }

    /* --- BOJOVN칈CI --- */
    /* 1. 칔PRAVA KONTEJNERU: Aby se p콏izp콢sobil v칳코ce postavy */
    .fighter {
        position: relative;
        width: 200px; /* 먞솬뗢a sloupce z콢st치v치, aby HP bar neul칠tl */
        height: auto; /* ZM캨NA: V칳코ka se p콏izp콢sob칤 obsahu */
        min-height: 300px; /* Minim치ln칤 v칳코ka, aby postavy nebyly "zapadl칠" v zemi */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end; /* ZM캨NA: Obsah se zarovn치 dol콢 k zemi */
        transition: transform 0.2s;
        z-index: 10;
        padding-bottom: 10px; /* Mal치 mezera od spodn칤 hrany ar칠ny */
    }

    /* 2. 칔PRAVA OBR츼ZKU: Zlat칳 adaptivn칤 r치me캜ek */
    .fighter-img {
        /* ZM캨NA: M칤sto fixn칤ch 200px d치me limity */
        width: auto; 
        height: auto;
        max-width: 200px;  /* Maxim치ln칤 코칤콏ka */
        max-height: 220px; /* Maxim치ln칤 v칳코ka (trochu v칤c pro vysok칠 postavy) */
        
        object-fit: contain; /* Pro jistotu */
        
        /* Zlat칳 RPG r치me캜ek */
        border: 3px solid #f1c40f; 
        border-radius: 15px;
        
        /* Efekty pozad칤 a st칤nu */
        background: radial-gradient(circle, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 80%);
        box-shadow: 
            inset 0 0 20px rgba(0,0,0,0.8), /* Vnit콏n칤 st칤n */
            0 0 10px rgba(241, 196, 15, 0.5), /* Zlat치 z치콏e */
            0 10px 20px rgba(0,0,0,0.6);      /* St칤n pod kartou */
            
        transition: transform 0.2s, filter 0.3s;
    }

    .fighter-img.dead {
        filter: grayscale(100%) blur(2px);
        opacity: 0.6;
    }

    /* --- HP BARY --- */
    .hp-box {
        width: 100%;
        background: #333;
        border: 2px solid #000;
        border-radius: 5px;
        height: 25px;
        margin-top: 10px;
        position: relative;
    }

    .hp-bar {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        width: 100%;
        transition: width 0.5s ease-out;
    }

    .hp-text {
        position: absolute;
        top: 0; left: 0; width: 100%;
        text-align: center;
        color: white;
        font-weight: bold;
        line-height: 22px;
        font-size: 14px;
        text-shadow: 1px 1px 2px black;
    }

    .name-tag {
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 2px 10px;
        border-radius: 4px;
        margin-bottom: 5px;
        font-weight: bold;
        text-align: center;
    }

    /* --- ANIMACE BOJE --- */
    @keyframes lunge-right {
        0% { transform: translateX(0); }
        30% { transform: translateX(-20px) rotate(-5deg); }
        50% { transform: translateX(150px) rotate(5deg); }
        100% { transform: translateX(0); }
    }

    @keyframes lunge-left {
        0% { transform: translateX(0); }
        30% { transform: translateX(20px) rotate(5deg); }
        50% { transform: translateX(-150px) rotate(-5deg); }
        100% { transform: translateX(0); }
    }

    @keyframes shake-hit {
        0% { transform: translate(0, 0); filter: brightness(1); }
        10% { transform: translate(-5px, 0); filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); }
        30% { transform: translate(5px, 0); }
        50% { transform: translate(-5px, 0); }
        70% { transform: translate(5px, 0); }
        100% { transform: translate(0, 0); filter: brightness(1); }
    }

    /* --- NOV칄 ANIMACE PRO KRITICK칗 Z츼SAH A OBRANU --- */
    
    /* 1. Kritick칳 z치sah - siln캩j코칤 ot콏es + 캜erven칳 z치blesk */
    @keyframes shake-hard {
        0% { transform: translate(0, 0); filter: brightness(1); }
        10% { transform: translate(-10px, -5px) rotate(-5deg); filter: brightness(3) sepia(1) hue-rotate(-50deg); } 
        30% { transform: translate(10px, 5px) rotate(5deg); }
        50% { transform: translate(-10px, 0); }
        70% { transform: translate(10px, 0); }
        100% { transform: translate(0, 0); filter: brightness(1); }
    }

    /* 2. Obrann칳 postoj - zv캩t코en칤 a modr치 aura */
    @keyframes defense-pulse {
        0% { transform: scale(1); box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        50% { transform: scale(1.15); box-shadow: 0 0 25px rgba(52, 152, 219, 0.8); border-color: #3498db; }
        100% { transform: scale(1); box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
    }

    .dmg-floater {
        position: absolute;
        top: 20%; left: 50%;
        transform: translate(-50%, -50%);
        color: #ff0000;
        font-size: 3rem;
        font-weight: 900;
        text-shadow: 0 0 5px #fff, 2px 2px 0 #000;
        opacity: 0;
        pointer-events: none;
        z-index: 20;
    }

    @keyframes float-up-fade {
        0% { opacity: 1; transform: translate(-50%, 0) scale(0.5); }
        20% { transform: translate(-50%, -30px) scale(1.5); }
        100% { opacity: 0; transform: translate(-50%, -80px) scale(1); }
    }

    .anim-attack-right { animation: lunge-right 0.4s ease-in-out; }
    .anim-attack-left { animation: lunge-left 0.4s ease-in-out; }
    .anim-shake { animation: shake-hit 0.2s ease-in-out; }
    .anim-float { animation: float-up-fade 1.5s forwards; }
    
    /* T콏칤dy pro nov칠 animace */
    .anim-shake-hard { animation: shake-hard 0.4s ease-in-out; }
    .anim-defensive { animation: defense-pulse 1.0s ease-in-out; }

    /* --- NOV칗 DESIGN V칗SLEDKU (OVERLAY) --- */
    .result-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7); /* Ztmaven칤 pozad칤 */
        backdrop-filter: blur(4px);
        z-index: 100;
        display: none; /* Skryto defaultn캩 */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.8s forwards;
    }

    .result-card {
        background: #fff;
        padding: 2rem 4rem;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 0 50px rgba(0,0,0,0.8);
        transform: scale(0.5);
        opacity: 0;
        animation: popIn 0.6s 0.2s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Pru쬹칳 efekt */
        border: 5px solid #333;
        max-width: 80%;
    }

    .result-title {
        font-size: 4rem;
        font-weight: 900;
        margin: 0;
        text-transform: uppercase;
        -webkit-text-stroke: 2px black; /* 캛ern칳 obrys textu */
        text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
    }

    .result-subtitle {
        font-size: 1.5rem;
        color: #555;
        margin: 1rem 0 2rem 0;
        font-weight: bold;
    }

    /* Styly pro V칤t캩zstv칤 */
    .victory-theme {
        border-color: #f1c40f;
        background: linear-gradient(135deg, #fffcf0, #fff);
        box-shadow: 0 0 60px rgba(241, 196, 15, 0.6);
    }
    .victory-text { color: #f1c40f; }

    /* Styly pro Prohru */
    .defeat-theme {
        border-color: #c0392b;
        background: linear-gradient(135deg, #fff0f0, #fff);
        box-shadow: 0 0 60px rgba(192, 57, 43, 0.6);
    }
    .defeat-text { color: #c0392b; }

    /* Animace overlaye */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { to { opacity: 1; transform: scale(1); } }

    /* UI pod ar칠nou */
    .battle-ui {
        text-align: center;
        margin-top: 20px;
    }

    #log-display {
        min-height: 40px;
        font-size: 1.2rem;
        color: #333;
        font-style: italic;
        margin-bottom: 20px;
    }

</style>

<div class="container">
    <div class="arena-wrapper">
        
        <div class="fighter" id="hero-slot">
            <div class="name-tag" id="hero-name">Hr치캜</div>
            <div style="position: relative;">
                <img src="{% static 'game/img/default_avatar.png' %}" id="hero-img" class="fighter-img" alt="Hrdina">
                <div class="dmg-floater" id="hero-dmg-float"></div>
            </div>
            <div class="hp-box">
                <div class="hp-bar" id="hero-hp-bar" style="width: 100%;"></div>
                <div class="hp-text" id="hero-hp-text">p콏ipraven</div>
            </div>
        </div>

        <div class="fighter" id="boss-slot">
            <div class="name-tag">{{ fight_log.boss.name }} (Lvl {{ fight_log.boss.lvl }})</div>
            <div style="position: relative;">
                {% if fight_log.boss.boss_img %}
                    <img src="{{ fight_log.boss.boss_img.url }}" id="boss-img" class="fighter-img" alt="Boss">
                {% else %}
                    <img src="{% static 'game/img/default_boss.png' %}" id="boss-img" class="fighter-img" alt="Boss">
                {% endif %}
                <div class="dmg-floater" id="boss-dmg-float"></div>
            </div>
            <div class="hp-box">
                <div class="hp-bar" id="boss-hp-bar" style="width: 100%;"></div>
                <div class="hp-text" id="boss-hp-text">100%</div>
            </div>
        </div>

        <div id="result-overlay" class="result-overlay">
            <div id="result-card" class="result-card">
                <h1 id="result-title" class="result-title">V칗SLEDEK</h1>
                <p id="result-msg" class="result-subtitle">Popis v칳sledku</p>
                <a href="{% url 'dungeon' %}" class="btn btn-primary btn-lg">Pokra캜ovat v Dungeonu</a>
            </div>
        </div>

    </div>

    <div class="battle-ui">
        <div id="log-display">Na캜칤t치m souboj...</div>
    </div>
</div>

<script>
    // 1. DATA
    const fightData = [
        {% for turn in turn_logs %}
        {
            turn: {{ turn.turn_number }},
            is_boss_attacker: {% if turn.attacker_is_boss %}true{% else %}false{% endif %},
            dmg: {{ turn.damage_dealt }},
            
            // --- NOV칄 POLO콯KY ---
            is_critical: {% if turn.critic_status %}true{% else %}false{% endif %},
            is_defensive: {% if turn.bojovy_postoj_status %}true{% else %}false{% endif %},
            // --------------------
            
            player_name: "{% if turn.attacker_is_boss %}{{ turn.target_player.name|escapejs }}{% else %}{{ turn.attacker_player.name|escapejs }}{% endif %}",
            player_img_url: "{% if turn.attacker_is_boss %}{% if turn.target_player.profile_img %}{{ turn.target_player.profile_img.url }}{% endif %}{% else %}{% if turn.attacker_player.profile_img %}{{ turn.attacker_player.profile_img.url }}{% endif %}{% endif %}",
            
            boss_hp_after: {{ turn.boss_hp_after }},
            boss_max_hp: {{ turn.boss_max_hp|default:100 }},
            
            player_hp_after: {% if turn.target_player_hp_after is not None %}{{ turn.target_player_hp_after }}{% else %}null{% endif %},
            player_max_hp: {% if turn.target_player_max_hp is not None %}{{ turn.target_player_max_hp }}{% else %}100{% endif %}
        },
        {% endfor %}
    ];

    const finalOutcome = "{{ fight_log.outcome }}";

    // 2. ELEMENTY
    const els = {
        heroSlot: document.getElementById('hero-slot'),
        bossSlot: document.getElementById('boss-slot'),
        heroImg: document.getElementById('hero-img'),
        bossImg: document.getElementById('boss-img'),
        heroName: document.getElementById('hero-name'),
        heroHpBar: document.getElementById('hero-hp-bar'),
        heroHpText: document.getElementById('hero-hp-text'),
        bossHpBar: document.getElementById('boss-hp-bar'),
        bossHpText: document.getElementById('boss-hp-text'),
        logText: document.getElementById('log-display'),
        heroDmgFloat: document.getElementById('hero-dmg-float'),
        bossDmgFloat: document.getElementById('boss-dmg-float'),
        
        // V칳sledkov칠 elementy
        overlay: document.getElementById('result-overlay'),
        card: document.getElementById('result-card'),
        title: document.getElementById('result-title'),
        msg: document.getElementById('result-msg')
    };

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));



// --- NOV츼 FUNKCE: P콎EDNA캛TEN칈 OBR츼ZK콡 ---
    function preloadImages() {
        // 1. Z칤sk치me seznam v코ech unik치tn칤ch URL obr치zk콢 z fightData
        const uniqueUrls = new Set();
        
        // P콏id치me defaultn칤 avatar (pro jistotu)
        uniqueUrls.add("{% static 'game/img/default_avatar.png' %}");
        
        // Projdeme logy a vyt치hneme obr치zky hr치캜콢
        fightData.forEach(turn => {
            if (turn.player_img_url) {
                uniqueUrls.add(turn.player_img_url);
            }
        });

        // 2. Vytvo콏칤me Promise pro ka쬯칳 obr치zek
        const imagePromises = Array.from(uniqueUrls).map(url => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = url;
                img.onload = () => resolve(url);
                img.onerror = () => resolve(url); // I kdy sel쬰, pokra캜ujeme, a콘 se to nezasekne
            });
        });

        return Promise.all(imagePromises);
    }

// 3. HLAVN칈 SMY캛KA
    async function runBattle() {
        // Zm캩na hl치코ky
        els.logText.innerText = "Na캜칤t치m textury bojovn칤k콢...";
        
        // 캛EK츼ME, dokud se v코echny obr치zky nest치hnou do pam캩ti
        await preloadImages();

        els.logText.innerText = "V코e p콏ipraveno! Souboj za캜칤n치!";
        await wait(1000); 

        for (let i = 0; i < fightData.length; i++) {
            await playTurn(fightData[i]);
        }

        showResult();
    }

    // 4. ANIMACE TAHU
    async function playTurn(turn) {
        // Zm캩na hr치캜e + okam쬴t칳 update HP baru
        if (turn.player_img_url) {
            els.heroImg.src = turn.player_img_url;
        } else {
            els.heroImg.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png"; 
        }
        els.heroName.innerText = turn.player_name;
        
        // V칳po캜et startovn칤ho HP pro tento tah
        let startHp = turn.player_hp_after;
        if (turn.is_boss_attacker && turn.player_hp_after !== null) {
            startHp = turn.player_hp_after + turn.dmg;
            if (startHp > turn.player_max_hp) startHp = turn.player_max_hp;
        }

        // Okam쬴t칳 set HP (vypnut칤 animace)
        els.heroHpBar.style.transition = 'none';
        updateHpBar(els.heroHpBar, els.heroHpText, startHp, turn.player_max_hp);
        void els.heroHpBar.offsetWidth; // Reflow trigger
        els.heroHpBar.style.transition = 'width 0.5s ease-out';

        await wait(200);

        // Ur캜en칤 element콢 pro 칰to캜n칤ka a obr치nce
        let attackerSlot, defenderSlot, defenderHpBar, defenderHpText, defenderDmgFloat, animAttack;
        let defenderHpAfter, defenderMaxHp;

        if (turn.is_boss_attacker) {
            // BOSS -> HR츼캛
            attackerSlot = els.bossSlot;
            defenderSlot = els.heroSlot; // Tady je avatar hr치캜e
            defenderHpBar = els.heroHpBar;
            defenderHpText = els.heroHpText;
            defenderDmgFloat = els.heroDmgFloat;
            animAttack = 'anim-attack-left';
            
            defenderHpAfter = turn.player_hp_after;
            defenderMaxHp = turn.player_max_hp;
            
            els.logText.innerText = `游냨 Boss 칰to캜칤 na ${turn.player_name}!`;
        } else {
            // HR츼캛 -> BOSS
            attackerSlot = els.heroSlot;
            defenderSlot = els.bossSlot;
            defenderHpBar = els.bossHpBar;
            defenderHpText = els.bossHpText;
            defenderDmgFloat = els.bossDmgFloat;
            animAttack = 'anim-attack-right';

            defenderHpAfter = turn.boss_hp_after;
            defenderMaxHp = turn.boss_max_hp;

            els.logText.innerText = `丘덢잺 ${turn.player_name} 칰to캜칤 na Bosse!`;
        }

        // --- OBRANN칗 POSTOJ ---
        // Pokud je aktivn칤 obrann칳 postoj, spust칤me animaci na obr치nci TE캝 (p콏ed z치sahem)
        if (turn.is_defensive) {
            const defenderImg = defenderSlot.querySelector('.fighter-img');
            defenderImg.classList.add('anim-defensive');
            // Mal치 pauza, aby hr치캜 stihl zaregistrovat obranu
            await wait(300);
        }

        // Spu코t캩n칤 칰toku
        attackerSlot.classList.add(animAttack);
        await wait(300); // 캛as ne 칰tok "dopadne"

        // --- KRITICK칗 Z츼SAH ---
        if (turn.is_critical) {
            defenderSlot.classList.add('anim-shake-hard');
            els.logText.innerText += " (KRITICK칗 Z츼SAH!)";
        } else {
            defenderSlot.classList.add('anim-shake');
        }

        showFloatingDamage(defenderDmgFloat, turn.dmg, turn.is_critical);
        updateHpBar(defenderHpBar, defenderHpText, defenderHpAfter, defenderMaxHp);

        await wait(300); // 캛as na dokon캜en칤 animace ot콏esu

        // Cleanup animac칤
        attackerSlot.classList.remove(animAttack);
        defenderSlot.classList.remove('anim-shake');
        defenderSlot.classList.remove('anim-shake-hard');
        
        // Odstran캩n칤 obrann칠 t콏칤dy z obr치zku
        const defenderImg = defenderSlot.querySelector('.fighter-img');
        if (defenderImg) defenderImg.classList.remove('anim-defensive');

        await wait(500);
    }

    function showFloatingDamage(element, dmg, isCritical) {
        if (dmg <= 0) {
            element.innerText = "MISS";
            element.style.color = "#bdc3c7";
            element.style.fontSize = "3rem";
        } else {
            element.innerText = "-" + dmg;
            if (isCritical) {
                element.style.color = "#e74c3c"; // Jasn캩j코칤 캜erven치
                element.style.fontSize = "4.5rem"; // V캩t코칤 text
                element.innerText += "!";
            } else {
                element.style.color = "#ff0000";
                element.style.fontSize = "3rem";
            }
        }
        element.classList.remove('anim-float');
        void element.offsetWidth; 
        element.classList.add('anim-float');
    }

    function updateHpBar(barEl, textEl, current, max) {
        if (current === null) return;
        if (current < 0) current = 0;
        const percent = (current / max) * 100;
        barEl.style.width = percent + "%";
        textEl.innerText = `${current} / ${max}`;
    }

    // 5. ZOBRAZEN칈 V칗SLEDKU (OVERLAY)
    function showResult() {
        els.overlay.style.display = 'flex'; // Zobraz칤me overlay

        if (finalOutcome === 'players') {
            // V칤t캩zstv칤
            els.card.classList.add('victory-theme');
            els.title.innerText = "V칈T캨ZSTV칈!";
            els.title.classList.add('victory-text');
            els.msg.innerText = "Boss byl pora쬰n, sl치va hrdin콢m!";
            els.bossImg.classList.add('dead');
            els.logText.innerText = "Sl치va v칤t캩z콢m!";
        } else {
            // Prohra
            els.card.classList.add('defeat-theme');
            els.title.innerText = "POR츼콯KA";
            els.title.classList.add('defeat-text');
            els.msg.innerText = "V치코 t칳m byl zmasakrov치n...";
            els.heroImg.classList.add('dead');
            els.logText.innerText = "캛est pora쬰n칳m...";
        }
    }
    
    // Fallback obr치zky
    document.querySelectorAll('img').forEach(img => {
        img.onerror = function() {
            this.src = '{% static "game/img/default_avatar.png" %}'; 
        };
    });

    // 6. AUTOMATICK칗 START PO NA캛TEN칈
    document.addEventListener("DOMContentLoaded", function() {
        runBattle();
    });

</script>

{% endblock content %}